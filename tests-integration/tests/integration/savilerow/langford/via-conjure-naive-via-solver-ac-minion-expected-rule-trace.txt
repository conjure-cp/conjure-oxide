Model before rewriting:

letting k be 3
find position: matrix indexed by [positionDomain] of positionDomain
letting positionDomain be domain int(1..two_k)
letting two_k be 6

such that

and([ (position[sum([i,k;int(1..2)])] = sum([sum([position[i],i;int(1..2)]),1;int(1..2)])) | i : int(1..k) ]),
allDiff(position)

--

and([ (position[sum([i,k;int(1..2)])] = sum([sum([position[i],i;int(1..2)]),1;int(1..2)])) | i : int(1..k) ]),
allDiff(position), 
   ~~> constant_evaluator ([("Constant", 9001)])
and([ (position[sum([i,3;int(1..2)])] = sum([sum([position[i],i;int(1..2)]),1;int(1..2)])) | i : int(1..k) ]),
allDiff(position)

--

and([ (position#matrix_to_atom[sum([i,3;int(1..2)])] = sum([sum([position#matrix_to_atom[i],i;int(1..2)]),1;int(1..2)])) | i : int(1..k) ]),
allDiff(position#matrix_to_atom), 
   ~~> select_representation_matrix ([("Representations", 8001)])
and([ (position#matrix_to_atom[sum([i,3;int(1..2)])] = sum([sum([position#matrix_to_atom[i],i;int(1..2)]),1;int(1..2)])) | i : int(1..k) ]),
allDiff(position#matrix_to_atom)
new variables:
  find position#matrix_to_atom_1: int(1..6)
  find position#matrix_to_atom_2: int(1..6)
  find position#matrix_to_atom_3: int(1..6)
  find position#matrix_to_atom_4: int(1..6)
  find position#matrix_to_atom_5: int(1..6)
  find position#matrix_to_atom_6: int(1..6)

--

Model before rewriting:

find i: int(1..k)
find __0: matrix indexed by [positionDomain] of positionDomain

such that

(true != (__0[sum([i,3;int(1..2)])] = sum([sum([__0[i],i;int(1..2)]),1;int(1..2)])))

--

sum([sum([__0[i],i;int(1..2)]),1;int(1..2)]), 
   ~~> normalise_associative_commutative ([("Base", 8900)])
sum([__0[i],i,1;int(1..2)])

--

(true != (__0#matrix_to_atom[sum([i,3;int(1..2)])] = sum([__0#matrix_to_atom[i],i,1;int(1..2)]))), 
   ~~> select_representation_matrix ([("Representations", 8001)])
(true != (__0#matrix_to_atom[sum([i,3;int(1..2)])] = sum([__0#matrix_to_atom[i],i,1;int(1..2)])))
new variables:
  find __0#matrix_to_atom_1: int(1..6)
  find __0#matrix_to_atom_2: int(1..6)
  find __0#matrix_to_atom_3: int(1..6)
  find __0#matrix_to_atom_4: int(1..6)
  find __0#matrix_to_atom_5: int(1..6)
  find __0#matrix_to_atom_6: int(1..6)

--

__0#matrix_to_atom[sum([i,3;int(1..2)])], 
   ~~> index_to_bubble ([("Bubble", 6000)])
{__0#matrix_to_atom[sum([i,3;int(1..2)])] @ and([__inDomain(sum([i,3;int(1..2)]),int(1..6));int(1..)])}

--

({__0#matrix_to_atom[sum([i,3;int(1..2)])] @ and([__inDomain(sum([i,3;int(1..2)]),int(1..6));int(1..)])} = sum([__0#matrix_to_atom[i],i,1;int(1..2)])), 
   ~~> bubble_up ([("Bubble", 8800)])
{(__0#matrix_to_atom[sum([i,3;int(1..2)])] = sum([__0#matrix_to_atom[i],i,1;int(1..2)])) @ and([__inDomain(sum([i,3;int(1..2)]),int(1..6));int(1..)])}

--

{(__0#matrix_to_atom[sum([i,3;int(1..2)])] = sum([__0#matrix_to_atom[i],i,1;int(1..2)])) @ and([__inDomain(sum([i,3;int(1..2)]),int(1..6));int(1..)])}, 
   ~~> expand_bubble ([("Bubble", 8900)])
and([(__0#matrix_to_atom[sum([i,3;int(1..2)])] = sum([__0#matrix_to_atom[i],i,1;int(1..2)])),and([__inDomain(sum([i,3;int(1..2)]),int(1..6));int(1..)]);int(1..)])

--

and([__inDomain(sum([i,3;int(1..2)]),int(1..6));int(1..)]), 
   ~~> remove_unit_vector_and ([("Base", 8800)])
__inDomain(sum([i,3;int(1..2)]),int(1..6))

--

__0#matrix_to_atom[i], 
   ~~> index_to_bubble ([("Bubble", 6000)])
{__0#matrix_to_atom[i] @ and([__inDomain(i,int(1..6));int(1..)])}

--

(true != and([(__0#matrix_to_atom[sum([i,3;int(1..2)])] = sum([{__0#matrix_to_atom[i] @ and([__inDomain(i,int(1..6));int(1..)])},i,1;int(1..2)])),__inDomain(sum([i,3;int(1..2)]),int(1..6));int(1..)])), 
   ~~> constant_evaluator ([("Constant", 9001)])
(true != and([(__0#matrix_to_atom[sum([i,3;int(1..2)])] = sum([__0#matrix_to_atom[i],i,1;int(1..2)])),__inDomain(sum([i,3;int(1..2)]),int(1..6));int(1..)]))

--

(true != and([(__0#matrix_to_atom[sum([i,3;int(1..2)])] = sum([__0#matrix_to_atom[i],i,1;int(1..2)])),__inDomain(sum([i,3;int(1..2)]),int(1..6));int(1..)])), 
   ~~> index_matrix_to_atom ([("Base", 5000)])
(true != and([([__0#matrix_to_atom_1,__0#matrix_to_atom_2,__0#matrix_to_atom_3,__0#matrix_to_atom_4,__0#matrix_to_atom_5,__0#matrix_to_atom_6;int(1..)][(sum([i,3;int(1..2)]) - 0)] = sum([[__0#matrix_to_atom_1,__0#matrix_to_atom_2,__0#matrix_to_atom_3,__0#matrix_to_atom_4,__0#matrix_to_atom_5,__0#matrix_to_atom_6;int(1..)][(i - 0)],i,1;int(1..2)])),__inDomain(sum([i,3;int(1..2)]),int(1..6));int(1..)]))

--

(sum([i,3;int(1..2)]) - 0), 
   ~~> minus_to_sum ([("Base", 8400)])
sum([sum([i,3;int(1..2)]),-(0);int(1..)])

--

(true != and([([__0#matrix_to_atom_1,__0#matrix_to_atom_2,__0#matrix_to_atom_3,__0#matrix_to_atom_4,__0#matrix_to_atom_5,__0#matrix_to_atom_6;int(1..)][sum([sum([i,3;int(1..2)]),-(0);int(1..)])] = sum([[__0#matrix_to_atom_1,__0#matrix_to_atom_2,__0#matrix_to_atom_3,__0#matrix_to_atom_4,__0#matrix_to_atom_5,__0#matrix_to_atom_6;int(1..)][(i - 0)],i,1;int(1..2)])),__inDomain(sum([i,3;int(1..2)]),int(1..6));int(1..)])), 
   ~~> constant_evaluator ([("Constant", 9001)])
(true != and([([__0#matrix_to_atom_1,__0#matrix_to_atom_2,__0#matrix_to_atom_3,__0#matrix_to_atom_4,__0#matrix_to_atom_5,__0#matrix_to_atom_6;int(1..)][sum([sum([i,3;int(1..2)]),0;int(1..)])] = sum([[__0#matrix_to_atom_1,__0#matrix_to_atom_2,__0#matrix_to_atom_3,__0#matrix_to_atom_4,__0#matrix_to_atom_5,__0#matrix_to_atom_6;int(1..)][(i - 0)],i,1;int(1..2)])),__inDomain(sum([i,3;int(1..2)]),int(1..6));int(1..)]))

--

sum([sum([i,3;int(1..2)]),0;int(1..)]), 
   ~~> normalise_associative_commutative ([("Base", 8900)])
sum([i,3,0;int(1..)])

--

(true != and([([__0#matrix_to_atom_1,__0#matrix_to_atom_2,__0#matrix_to_atom_3,__0#matrix_to_atom_4,__0#matrix_to_atom_5,__0#matrix_to_atom_6;int(1..)][sum([i,3,0;int(1..)])] = sum([[__0#matrix_to_atom_1,__0#matrix_to_atom_2,__0#matrix_to_atom_3,__0#matrix_to_atom_4,__0#matrix_to_atom_5,__0#matrix_to_atom_6;int(1..)][(i - 0)],i,1;int(1..2)])),__inDomain(sum([i,3;int(1..2)]),int(1..6));int(1..)])), 
   ~~> constant_evaluator ([("Constant", 9001)])
(true != and([([__0#matrix_to_atom_1,__0#matrix_to_atom_2,__0#matrix_to_atom_3,__0#matrix_to_atom_4,__0#matrix_to_atom_5,__0#matrix_to_atom_6;int(1..)][sum([i,3;int(1..)])] = sum([[__0#matrix_to_atom_1,__0#matrix_to_atom_2,__0#matrix_to_atom_3,__0#matrix_to_atom_4,__0#matrix_to_atom_5,__0#matrix_to_atom_6;int(1..)][(i - 0)],i,1;int(1..2)])),__inDomain(sum([i,3;int(1..2)]),int(1..6));int(1..)]))

--

(i - 0), 
   ~~> minus_to_sum ([("Base", 8400)])
sum([i,-(0);int(1..)])

--

(true != and([([__0#matrix_to_atom_1,__0#matrix_to_atom_2,__0#matrix_to_atom_3,__0#matrix_to_atom_4,__0#matrix_to_atom_5,__0#matrix_to_atom_6;int(1..)][sum([i,3;int(1..)])] = sum([[__0#matrix_to_atom_1,__0#matrix_to_atom_2,__0#matrix_to_atom_3,__0#matrix_to_atom_4,__0#matrix_to_atom_5,__0#matrix_to_atom_6;int(1..)][sum([i,-(0);int(1..)])],i,1;int(1..2)])),__inDomain(sum([i,3;int(1..2)]),int(1..6));int(1..)])), 
   ~~> constant_evaluator ([("Constant", 9001)])
(true != and([([__0#matrix_to_atom_1,__0#matrix_to_atom_2,__0#matrix_to_atom_3,__0#matrix_to_atom_4,__0#matrix_to_atom_5,__0#matrix_to_atom_6;int(1..)][sum([i,3;int(1..)])] = sum([[__0#matrix_to_atom_1,__0#matrix_to_atom_2,__0#matrix_to_atom_3,__0#matrix_to_atom_4,__0#matrix_to_atom_5,__0#matrix_to_atom_6;int(1..)][sum([i,0;int(1..)])],i,1;int(1..2)])),__inDomain(sum([i,3;int(1..2)]),int(1..6));int(1..)]))

--

(true != and([([__0#matrix_to_atom_1,__0#matrix_to_atom_2,__0#matrix_to_atom_3,__0#matrix_to_atom_4,__0#matrix_to_atom_5,__0#matrix_to_atom_6;int(1..)][sum([i,3;int(1..)])] = sum([[__0#matrix_to_atom_1,__0#matrix_to_atom_2,__0#matrix_to_atom_3,__0#matrix_to_atom_4,__0#matrix_to_atom_5,__0#matrix_to_atom_6;int(1..)][sum([i,0;int(1..)])],i,1;int(1..2)])),__inDomain(sum([i,3;int(1..2)]),int(1..6));int(1..)])), 
   ~~> flatten_generic ([("Minion", 4200)])
(true != __1)
new variables:
  find __1: bool
new constraints:
  __1 =aux and([([__0#matrix_to_atom_1,__0#matrix_to_atom_2,__0#matrix_to_atom_3,__0#matrix_to_atom_4,__0#matrix_to_atom_5,__0#matrix_to_atom_6;int(1..)][sum([i,3;int(1..)])] = sum([[__0#matrix_to_atom_1,__0#matrix_to_atom_2,__0#matrix_to_atom_3,__0#matrix_to_atom_4,__0#matrix_to_atom_5,__0#matrix_to_atom_6;int(1..)][sum([i,0;int(1..)])],i,1;int(1..2)])),__inDomain(sum([i,3;int(1..2)]),int(1..6));int(1..)])

--

__1 =aux and([([__0#matrix_to_atom_1,__0#matrix_to_atom_2,__0#matrix_to_atom_3,__0#matrix_to_atom_4,__0#matrix_to_atom_5,__0#matrix_to_atom_6;int(1..)][sum([i,3;int(1..)])] = sum([[__0#matrix_to_atom_1,__0#matrix_to_atom_2,__0#matrix_to_atom_3,__0#matrix_to_atom_4,__0#matrix_to_atom_5,__0#matrix_to_atom_6;int(1..)][sum([i,0;int(1..)])],i,1;int(1..2)])),__inDomain(sum([i,3;int(1..2)]),int(1..6));int(1..)]), 
   ~~> bool_eq_to_reify ([("Minion", 4400)])
Reify(and([([__0#matrix_to_atom_1,__0#matrix_to_atom_2,__0#matrix_to_atom_3,__0#matrix_to_atom_4,__0#matrix_to_atom_5,__0#matrix_to_atom_6;int(1..)][sum([i,3;int(1..)])] = sum([[__0#matrix_to_atom_1,__0#matrix_to_atom_2,__0#matrix_to_atom_3,__0#matrix_to_atom_4,__0#matrix_to_atom_5,__0#matrix_to_atom_6;int(1..)][sum([i,0;int(1..)])],i,1;int(1..2)])),__inDomain(sum([i,3;int(1..2)]),int(1..6));int(1..)]), __1)

--

[__0#matrix_to_atom_1,__0#matrix_to_atom_2,__0#matrix_to_atom_3,__0#matrix_to_atom_4,__0#matrix_to_atom_5,__0#matrix_to_atom_6;int(1..)][sum([i,3;int(1..)])], 
   ~~> flatten_generic ([("Minion", 4200)])
[__0#matrix_to_atom_1,__0#matrix_to_atom_2,__0#matrix_to_atom_3,__0#matrix_to_atom_4,__0#matrix_to_atom_5,__0#matrix_to_atom_6;int(1..)][__2]
new variables:
  find __2: int(4..6)
new constraints:
  __2 =aux sum([i,3;int(1..)])

--

__2 =aux sum([i,3;int(1..)]), 
   ~~> introduce_weighted_sumleq_sumgeq ([("Minion", 4600)])
and([SumLeq([3, i], __2),SumGeq([3, i], __2);int(1..)])

--

(true != __1),
Reify(and([([__0#matrix_to_atom_1,__0#matrix_to_atom_2,__0#matrix_to_atom_3,__0#matrix_to_atom_4,__0#matrix_to_atom_5,__0#matrix_to_atom_6;int(1..)][__2] = sum([[__0#matrix_to_atom_1,__0#matrix_to_atom_2,__0#matrix_to_atom_3,__0#matrix_to_atom_4,__0#matrix_to_atom_5,__0#matrix_to_atom_6;int(1..)][sum([i,0;int(1..)])],i,1;int(1..2)])),__inDomain(sum([i,3;int(1..2)]),int(1..6));int(1..)]), __1),
and([SumLeq([3, i], __2),SumGeq([3, i], __2);int(1..)]), 
   ~~> constant_evaluator ([("Constant", 9001)])
(true != __1),
Reify(and([([__0#matrix_to_atom_1,__0#matrix_to_atom_2,__0#matrix_to_atom_3,__0#matrix_to_atom_4,__0#matrix_to_atom_5,__0#matrix_to_atom_6;int(1..)][__2] = sum([[__0#matrix_to_atom_1,__0#matrix_to_atom_2,__0#matrix_to_atom_3,__0#matrix_to_atom_4,__0#matrix_to_atom_5,__0#matrix_to_atom_6;int(1..)][sum([i,0;int(1..)])],i,1;int(1..2)])),__inDomain(sum([i,3;int(1..2)]),int(1..6));int(1..)]), __1),
SumLeq([3, i], __2),
SumGeq([3, i], __2)

--

[__0#matrix_to_atom_1,__0#matrix_to_atom_2,__0#matrix_to_atom_3,__0#matrix_to_atom_4,__0#matrix_to_atom_5,__0#matrix_to_atom_6;int(1..)][sum([i,0;int(1..)])], 
   ~~> flatten_generic ([("Minion", 4200)])
[__0#matrix_to_atom_1,__0#matrix_to_atom_2,__0#matrix_to_atom_3,__0#matrix_to_atom_4,__0#matrix_to_atom_5,__0#matrix_to_atom_6;int(1..)][__3]
new variables:
  find __3: int(1..3)
new constraints:
  __3 =aux sum([i,0;int(1..)])

--

__3 =aux sum([i,0;int(1..)]), 
   ~~> introduce_weighted_sumleq_sumgeq ([("Minion", 4600)])
and([SumLeq([0, i], __3),SumGeq([0, i], __3);int(1..)])

--

(true != __1),
Reify(and([([__0#matrix_to_atom_1,__0#matrix_to_atom_2,__0#matrix_to_atom_3,__0#matrix_to_atom_4,__0#matrix_to_atom_5,__0#matrix_to_atom_6;int(1..)][__2] = sum([[__0#matrix_to_atom_1,__0#matrix_to_atom_2,__0#matrix_to_atom_3,__0#matrix_to_atom_4,__0#matrix_to_atom_5,__0#matrix_to_atom_6;int(1..)][__3],i,1;int(1..2)])),__inDomain(sum([i,3;int(1..2)]),int(1..6));int(1..)]), __1),
SumLeq([3, i], __2),
SumGeq([3, i], __2),
and([SumLeq([0, i], __3),SumGeq([0, i], __3);int(1..)]), 
   ~~> constant_evaluator ([("Constant", 9001)])
(true != __1),
Reify(and([([__0#matrix_to_atom_1,__0#matrix_to_atom_2,__0#matrix_to_atom_3,__0#matrix_to_atom_4,__0#matrix_to_atom_5,__0#matrix_to_atom_6;int(1..)][__2] = sum([[__0#matrix_to_atom_1,__0#matrix_to_atom_2,__0#matrix_to_atom_3,__0#matrix_to_atom_4,__0#matrix_to_atom_5,__0#matrix_to_atom_6;int(1..)][__3],i,1;int(1..2)])),__inDomain(sum([i,3;int(1..2)]),int(1..6));int(1..)]), __1),
SumLeq([3, i], __2),
SumGeq([3, i], __2),
SumLeq([0, i], __3),
SumGeq([0, i], __3)

--

__inDomain(sum([i,3;int(1..2)]),int(1..6)), 
   ~~> flatten_generic ([("Minion", 4200)])
__inDomain(__4,int(1..6))
new variables:
  find __4: int(4..6)
new constraints:
  __4 =aux sum([i,3;int(1..2)])

--

(true != __1),
Reify(and([([__0#matrix_to_atom_1,__0#matrix_to_atom_2,__0#matrix_to_atom_3,__0#matrix_to_atom_4,__0#matrix_to_atom_5,__0#matrix_to_atom_6;int(1..)][__2] = sum([[__0#matrix_to_atom_1,__0#matrix_to_atom_2,__0#matrix_to_atom_3,__0#matrix_to_atom_4,__0#matrix_to_atom_5,__0#matrix_to_atom_6;int(1..)][__3],i,1;int(1..2)])),__inDomain(__4,int(1..6));int(1..)]), __1),
SumLeq([3, i], __2),
SumGeq([3, i], __2),
SumLeq([0, i], __3),
SumGeq([0, i], __3),
__4 =aux sum([i,3;int(1..2)]), 
   ~~> constant_evaluator ([("Constant", 9001)])
(true != __1),
Reify(and([([__0#matrix_to_atom_1,__0#matrix_to_atom_2,__0#matrix_to_atom_3,__0#matrix_to_atom_4,__0#matrix_to_atom_5,__0#matrix_to_atom_6;int(1..)][__2] = sum([[__0#matrix_to_atom_1,__0#matrix_to_atom_2,__0#matrix_to_atom_3,__0#matrix_to_atom_4,__0#matrix_to_atom_5,__0#matrix_to_atom_6;int(1..)][__3],i,1;int(1..2)]));int(1..)]), __1),
SumLeq([3, i], __2),
SumGeq([3, i], __2),
SumLeq([0, i], __3),
SumGeq([0, i], __3),
__4 =aux sum([i,3;int(1..2)])

--

and([([__0#matrix_to_atom_1,__0#matrix_to_atom_2,__0#matrix_to_atom_3,__0#matrix_to_atom_4,__0#matrix_to_atom_5,__0#matrix_to_atom_6;int(1..)][__2] = sum([[__0#matrix_to_atom_1,__0#matrix_to_atom_2,__0#matrix_to_atom_3,__0#matrix_to_atom_4,__0#matrix_to_atom_5,__0#matrix_to_atom_6;int(1..)][__3],i,1;int(1..2)]));int(1..)]), 
   ~~> remove_unit_vector_and ([("Base", 8800)])
([__0#matrix_to_atom_1,__0#matrix_to_atom_2,__0#matrix_to_atom_3,__0#matrix_to_atom_4,__0#matrix_to_atom_5,__0#matrix_to_atom_6;int(1..)][__2] = sum([[__0#matrix_to_atom_1,__0#matrix_to_atom_2,__0#matrix_to_atom_3,__0#matrix_to_atom_4,__0#matrix_to_atom_5,__0#matrix_to_atom_6;int(1..)][__3],i,1;int(1..2)]))

--

sum([[__0#matrix_to_atom_1,__0#matrix_to_atom_2,__0#matrix_to_atom_3,__0#matrix_to_atom_4,__0#matrix_to_atom_5,__0#matrix_to_atom_6;int(1..)][__3],i,1;int(1..2)]), 
   ~~> matrix_to_list ([("Base", 2000)])
sum([[__0#matrix_to_atom_1,__0#matrix_to_atom_2,__0#matrix_to_atom_3,__0#matrix_to_atom_4,__0#matrix_to_atom_5,__0#matrix_to_atom_6;int(1..)][__3],i,1;int(1..)])

--

sum([i,3;int(1..2)]), 
   ~~> matrix_to_list ([("Base", 2000)])
sum([i,3;int(1..)])

--

__4 =aux sum([i,3;int(1..)]), 
   ~~> introduce_weighted_sumleq_sumgeq ([("Minion", 4600)])
and([SumLeq([3, i], __4),SumGeq([3, i], __4);int(1..)])

--

(true != __1),
Reify(([__0#matrix_to_atom_1,__0#matrix_to_atom_2,__0#matrix_to_atom_3,__0#matrix_to_atom_4,__0#matrix_to_atom_5,__0#matrix_to_atom_6;int(1..)][__2] = sum([[__0#matrix_to_atom_1,__0#matrix_to_atom_2,__0#matrix_to_atom_3,__0#matrix_to_atom_4,__0#matrix_to_atom_5,__0#matrix_to_atom_6;int(1..)][__3],i,1;int(1..)])), __1),
SumLeq([3, i], __2),
SumGeq([3, i], __2),
SumLeq([0, i], __3),
SumGeq([0, i], __3),
and([SumLeq([3, i], __4),SumGeq([3, i], __4);int(1..)]), 
   ~~> constant_evaluator ([("Constant", 9001)])
(true != __1),
Reify(([__0#matrix_to_atom_1,__0#matrix_to_atom_2,__0#matrix_to_atom_3,__0#matrix_to_atom_4,__0#matrix_to_atom_5,__0#matrix_to_atom_6;int(1..)][__2] = sum([[__0#matrix_to_atom_1,__0#matrix_to_atom_2,__0#matrix_to_atom_3,__0#matrix_to_atom_4,__0#matrix_to_atom_5,__0#matrix_to_atom_6;int(1..)][__3],i,1;int(1..)])), __1),
SumLeq([3, i], __2),
SumGeq([3, i], __2),
SumLeq([0, i], __3),
SumGeq([0, i], __3),
SumLeq([3, i], __4),
SumGeq([3, i], __4)

--

Final model:

find i: int(1..k)
find __0: matrix indexed by [positionDomain] of positionDomain
find __1: bool
find __2: int(4..6)
find __3: int(1..3)
find __4: int(4..6)
find __0#matrix_to_atom_1: int(1..6)
find __0#matrix_to_atom_2: int(1..6)
find __0#matrix_to_atom_3: int(1..6)
find __0#matrix_to_atom_4: int(1..6)
find __0#matrix_to_atom_5: int(1..6)
find __0#matrix_to_atom_6: int(1..6)

such that

(true != __1),
Reify(([__0#matrix_to_atom_1,__0#matrix_to_atom_2,__0#matrix_to_atom_3,__0#matrix_to_atom_4,__0#matrix_to_atom_5,__0#matrix_to_atom_6;int(1..)][__2] = sum([[__0#matrix_to_atom_1,__0#matrix_to_atom_2,__0#matrix_to_atom_3,__0#matrix_to_atom_4,__0#matrix_to_atom_5,__0#matrix_to_atom_6;int(1..)][__3],i,1;int(1..)])), __1),
SumLeq([3, i], __2),
SumGeq([3, i], __2),
SumLeq([0, i], __3),
SumGeq([0, i], __3),
SumLeq([3, i], __4),
SumGeq([3, i], __4)

Via-solver generator model before rewriting:

find i: int(1..k)
find __0: matrix indexed by [positionDomain] of positionDomain
find __1: bool
find __2: int(4..6)
find __3: int(1..3)
find __4: int(4..6)
find __0#matrix_to_atom_1: int(1..6)
find __0#matrix_to_atom_2: int(1..6)
find __0#matrix_to_atom_3: int(1..6)
find __0#matrix_to_atom_4: int(1..6)
find __0#matrix_to_atom_5: int(1..6)
find __0#matrix_to_atom_6: int(1..6)

--

Model before rewriting:

find i: int(1..k)
find __0: matrix indexed by [positionDomain] of positionDomain
find __1: bool
find __2: int(4..6)
find __3: int(1..3)
find __4: int(4..6)
find __0#matrix_to_atom_1: int(1..6)
find __0#matrix_to_atom_2: int(1..6)
find __0#matrix_to_atom_3: int(1..6)
find __0#matrix_to_atom_4: int(1..6)
find __0#matrix_to_atom_5: int(1..6)
find __0#matrix_to_atom_6: int(1..6)

--

, 
   ~~> eval_root ([("Constant", 9001)])
true

--

Final model:

find i: int(1..k)
find __0: matrix indexed by [positionDomain] of positionDomain
find __1: bool
find __2: int(4..6)
find __3: int(1..3)
find __4: int(4..6)
find __0#matrix_to_atom_1: int(1..6)
find __0#matrix_to_atom_2: int(1..6)
find __0#matrix_to_atom_3: int(1..6)
find __0#matrix_to_atom_4: int(1..6)
find __0#matrix_to_atom_5: int(1..6)
find __0#matrix_to_atom_6: int(1..6)

such that

true

[ (position#matrix_to_atom[sum([i,3;int(1..2)])] = sum([sum([position#matrix_to_atom[i],i;int(1..2)]),1;int(1..2)])) | i : int(1..k) ], 
   ~~> expand_comprehension_via_solver ([("Base", 2000)])
[(position#matrix_to_atom[4] = sum([sum([position#matrix_to_atom[1],1;int(1..2)]),1;int(1..2)])),(position#matrix_to_atom[5] = sum([sum([position#matrix_to_atom[2],2;int(1..2)]),1;int(1..2)])),(position#matrix_to_atom[6] = sum([sum([position#matrix_to_atom[3],3;int(1..2)]),1;int(1..2)]));int(1..)]

--

and([(position#matrix_to_atom[4] = sum([sum([position#matrix_to_atom[1],1;int(1..2)]),1;int(1..2)])),(position#matrix_to_atom[5] = sum([sum([position#matrix_to_atom[2],2;int(1..2)]),1;int(1..2)])),(position#matrix_to_atom[6] = sum([sum([position#matrix_to_atom[3],3;int(1..2)]),1;int(1..2)]));int(1..)]),
allDiff(position#matrix_to_atom), 
   ~~> constant_evaluator ([("Constant", 9001)])
(position#matrix_to_atom[4] = sum([sum([position#matrix_to_atom[1],1;int(1..2)]),1;int(1..2)])),
(position#matrix_to_atom[5] = sum([sum([position#matrix_to_atom[2],2;int(1..2)]),1;int(1..2)])),
(position#matrix_to_atom[6] = sum([sum([position#matrix_to_atom[3],3;int(1..2)]),1;int(1..2)])),
allDiff(position#matrix_to_atom)

--

sum([sum([position#matrix_to_atom[1],1;int(1..2)]),1;int(1..2)]), 
   ~~> normalise_associative_commutative ([("Base", 8900)])
sum([position#matrix_to_atom[1],1,1;int(1..2)])

--

sum([sum([position#matrix_to_atom[2],2;int(1..2)]),1;int(1..2)]), 
   ~~> normalise_associative_commutative ([("Base", 8900)])
sum([position#matrix_to_atom[2],2,1;int(1..2)])

--

sum([sum([position#matrix_to_atom[3],3;int(1..2)]),1;int(1..2)]), 
   ~~> normalise_associative_commutative ([("Base", 8900)])
sum([position#matrix_to_atom[3],3,1;int(1..2)])

--

position#matrix_to_atom[4], 
   ~~> index_to_bubble ([("Bubble", 6000)])
{position#matrix_to_atom[4] @ and([__inDomain(4,int(1..6));int(1..)])}

--

({position#matrix_to_atom[4] @ and([__inDomain(4,int(1..6));int(1..)])} = sum([position#matrix_to_atom[1],1,1;int(1..2)])),
(position#matrix_to_atom[5] = sum([position#matrix_to_atom[2],2,1;int(1..2)])),
(position#matrix_to_atom[6] = sum([position#matrix_to_atom[3],3,1;int(1..2)])),
allDiff(position#matrix_to_atom), 
   ~~> constant_evaluator ([("Constant", 9001)])
(position#matrix_to_atom[4] = sum([position#matrix_to_atom[1],1,1;int(1..2)])),
(position#matrix_to_atom[5] = sum([position#matrix_to_atom[2],2,1;int(1..2)])),
(position#matrix_to_atom[6] = sum([position#matrix_to_atom[3],3,1;int(1..2)])),
allDiff(position#matrix_to_atom)

--

position#matrix_to_atom[1], 
   ~~> index_to_bubble ([("Bubble", 6000)])
{position#matrix_to_atom[1] @ and([__inDomain(1,int(1..6));int(1..)])}

--

(position#matrix_to_atom[4] = sum([{position#matrix_to_atom[1] @ and([__inDomain(1,int(1..6));int(1..)])},1,1;int(1..2)])),
(position#matrix_to_atom[5] = sum([position#matrix_to_atom[2],2,1;int(1..2)])),
(position#matrix_to_atom[6] = sum([position#matrix_to_atom[3],3,1;int(1..2)])),
allDiff(position#matrix_to_atom), 
   ~~> constant_evaluator ([("Constant", 9001)])
(position#matrix_to_atom[4] = sum([position#matrix_to_atom[1],1,1;int(1..2)])),
(position#matrix_to_atom[5] = sum([position#matrix_to_atom[2],2,1;int(1..2)])),
(position#matrix_to_atom[6] = sum([position#matrix_to_atom[3],3,1;int(1..2)])),
allDiff(position#matrix_to_atom)

--

position#matrix_to_atom[5], 
   ~~> index_to_bubble ([("Bubble", 6000)])
{position#matrix_to_atom[5] @ and([__inDomain(5,int(1..6));int(1..)])}

--

(position#matrix_to_atom[4] = sum([position#matrix_to_atom[1],1,1;int(1..2)])),
({position#matrix_to_atom[5] @ and([__inDomain(5,int(1..6));int(1..)])} = sum([position#matrix_to_atom[2],2,1;int(1..2)])),
(position#matrix_to_atom[6] = sum([position#matrix_to_atom[3],3,1;int(1..2)])),
allDiff(position#matrix_to_atom), 
   ~~> constant_evaluator ([("Constant", 9001)])
(position#matrix_to_atom[4] = sum([position#matrix_to_atom[1],1,1;int(1..2)])),
(position#matrix_to_atom[5] = sum([position#matrix_to_atom[2],2,1;int(1..2)])),
(position#matrix_to_atom[6] = sum([position#matrix_to_atom[3],3,1;int(1..2)])),
allDiff(position#matrix_to_atom)

--

position#matrix_to_atom[2], 
   ~~> index_to_bubble ([("Bubble", 6000)])
{position#matrix_to_atom[2] @ and([__inDomain(2,int(1..6));int(1..)])}

--

(position#matrix_to_atom[4] = sum([position#matrix_to_atom[1],1,1;int(1..2)])),
(position#matrix_to_atom[5] = sum([{position#matrix_to_atom[2] @ and([__inDomain(2,int(1..6));int(1..)])},2,1;int(1..2)])),
(position#matrix_to_atom[6] = sum([position#matrix_to_atom[3],3,1;int(1..2)])),
allDiff(position#matrix_to_atom), 
   ~~> constant_evaluator ([("Constant", 9001)])
(position#matrix_to_atom[4] = sum([position#matrix_to_atom[1],1,1;int(1..2)])),
(position#matrix_to_atom[5] = sum([position#matrix_to_atom[2],2,1;int(1..2)])),
(position#matrix_to_atom[6] = sum([position#matrix_to_atom[3],3,1;int(1..2)])),
allDiff(position#matrix_to_atom)

--

position#matrix_to_atom[6], 
   ~~> index_to_bubble ([("Bubble", 6000)])
{position#matrix_to_atom[6] @ and([__inDomain(6,int(1..6));int(1..)])}

--

(position#matrix_to_atom[4] = sum([position#matrix_to_atom[1],1,1;int(1..2)])),
(position#matrix_to_atom[5] = sum([position#matrix_to_atom[2],2,1;int(1..2)])),
({position#matrix_to_atom[6] @ and([__inDomain(6,int(1..6));int(1..)])} = sum([position#matrix_to_atom[3],3,1;int(1..2)])),
allDiff(position#matrix_to_atom), 
   ~~> constant_evaluator ([("Constant", 9001)])
(position#matrix_to_atom[4] = sum([position#matrix_to_atom[1],1,1;int(1..2)])),
(position#matrix_to_atom[5] = sum([position#matrix_to_atom[2],2,1;int(1..2)])),
(position#matrix_to_atom[6] = sum([position#matrix_to_atom[3],3,1;int(1..2)])),
allDiff(position#matrix_to_atom)

--

position#matrix_to_atom[3], 
   ~~> index_to_bubble ([("Bubble", 6000)])
{position#matrix_to_atom[3] @ and([__inDomain(3,int(1..6));int(1..)])}

--

(position#matrix_to_atom[4] = sum([position#matrix_to_atom[1],1,1;int(1..2)])),
(position#matrix_to_atom[5] = sum([position#matrix_to_atom[2],2,1;int(1..2)])),
(position#matrix_to_atom[6] = sum([{position#matrix_to_atom[3] @ and([__inDomain(3,int(1..6));int(1..)])},3,1;int(1..2)])),
allDiff(position#matrix_to_atom), 
   ~~> constant_evaluator ([("Constant", 9001)])
(position#matrix_to_atom[4] = sum([position#matrix_to_atom[1],1,1;int(1..2)])),
(position#matrix_to_atom[5] = sum([position#matrix_to_atom[2],2,1;int(1..2)])),
(position#matrix_to_atom[6] = sum([position#matrix_to_atom[3],3,1;int(1..2)])),
allDiff(position#matrix_to_atom)

--

(position#matrix_to_atom[4] = sum([position#matrix_to_atom[1],1,1;int(1..2)])),
(position#matrix_to_atom[5] = sum([position#matrix_to_atom[2],2,1;int(1..2)])),
(position#matrix_to_atom[6] = sum([position#matrix_to_atom[3],3,1;int(1..2)])),
allDiff(position#matrix_to_atom), 
   ~~> index_matrix_to_atom ([("Base", 5000)])
(position#matrix_to_atom_4 = sum([position#matrix_to_atom_1,1,1;int(1..2)])),
(position#matrix_to_atom_5 = sum([position#matrix_to_atom_2,2,1;int(1..2)])),
(position#matrix_to_atom_6 = sum([position#matrix_to_atom_3,3,1;int(1..2)])),
allDiff(position#matrix_to_atom)

--

sum([position#matrix_to_atom_1,1,1;int(1..2)]), 
   ~~> matrix_to_list ([("Base", 2000)])
sum([position#matrix_to_atom_1,1,1;int(1..)])

--

(position#matrix_to_atom_4 = sum([position#matrix_to_atom_1,1,1;int(1..)])),
(position#matrix_to_atom_5 = sum([position#matrix_to_atom_2,2,1;int(1..2)])),
(position#matrix_to_atom_6 = sum([position#matrix_to_atom_3,3,1;int(1..2)])),
allDiff(position#matrix_to_atom), 
   ~~> constant_evaluator ([("Constant", 9001)])
(position#matrix_to_atom_4 = sum([position#matrix_to_atom_1,2;int(1..)])),
(position#matrix_to_atom_5 = sum([position#matrix_to_atom_2,2,1;int(1..2)])),
(position#matrix_to_atom_6 = sum([position#matrix_to_atom_3,3,1;int(1..2)])),
allDiff(position#matrix_to_atom)

--

(position#matrix_to_atom_4 = sum([position#matrix_to_atom_1,2;int(1..)])), 
   ~~> introduce_weighted_sumleq_sumgeq ([("Minion", 4600)])
and([SumLeq([2, position#matrix_to_atom_1], position#matrix_to_atom_4),SumGeq([2, position#matrix_to_atom_1], position#matrix_to_atom_4);int(1..)])

--

and([SumLeq([2, position#matrix_to_atom_1], position#matrix_to_atom_4),SumGeq([2, position#matrix_to_atom_1], position#matrix_to_atom_4);int(1..)]),
(position#matrix_to_atom_5 = sum([position#matrix_to_atom_2,2,1;int(1..2)])),
(position#matrix_to_atom_6 = sum([position#matrix_to_atom_3,3,1;int(1..2)])),
allDiff(position#matrix_to_atom), 
   ~~> constant_evaluator ([("Constant", 9001)])
SumLeq([2, position#matrix_to_atom_1], position#matrix_to_atom_4),
SumGeq([2, position#matrix_to_atom_1], position#matrix_to_atom_4),
(position#matrix_to_atom_5 = sum([position#matrix_to_atom_2,2,1;int(1..2)])),
(position#matrix_to_atom_6 = sum([position#matrix_to_atom_3,3,1;int(1..2)])),
allDiff(position#matrix_to_atom)

--

sum([position#matrix_to_atom_2,2,1;int(1..2)]), 
   ~~> matrix_to_list ([("Base", 2000)])
sum([position#matrix_to_atom_2,2,1;int(1..)])

--

SumLeq([2, position#matrix_to_atom_1], position#matrix_to_atom_4),
SumGeq([2, position#matrix_to_atom_1], position#matrix_to_atom_4),
(position#matrix_to_atom_5 = sum([position#matrix_to_atom_2,2,1;int(1..)])),
(position#matrix_to_atom_6 = sum([position#matrix_to_atom_3,3,1;int(1..2)])),
allDiff(position#matrix_to_atom), 
   ~~> constant_evaluator ([("Constant", 9001)])
SumLeq([2, position#matrix_to_atom_1], position#matrix_to_atom_4),
SumGeq([2, position#matrix_to_atom_1], position#matrix_to_atom_4),
(position#matrix_to_atom_5 = sum([position#matrix_to_atom_2,3;int(1..)])),
(position#matrix_to_atom_6 = sum([position#matrix_to_atom_3,3,1;int(1..2)])),
allDiff(position#matrix_to_atom)

--

(position#matrix_to_atom_5 = sum([position#matrix_to_atom_2,3;int(1..)])), 
   ~~> introduce_weighted_sumleq_sumgeq ([("Minion", 4600)])
and([SumLeq([3, position#matrix_to_atom_2], position#matrix_to_atom_5),SumGeq([3, position#matrix_to_atom_2], position#matrix_to_atom_5);int(1..)])

--

SumLeq([2, position#matrix_to_atom_1], position#matrix_to_atom_4),
SumGeq([2, position#matrix_to_atom_1], position#matrix_to_atom_4),
and([SumLeq([3, position#matrix_to_atom_2], position#matrix_to_atom_5),SumGeq([3, position#matrix_to_atom_2], position#matrix_to_atom_5);int(1..)]),
(position#matrix_to_atom_6 = sum([position#matrix_to_atom_3,3,1;int(1..2)])),
allDiff(position#matrix_to_atom), 
   ~~> constant_evaluator ([("Constant", 9001)])
SumLeq([2, position#matrix_to_atom_1], position#matrix_to_atom_4),
SumGeq([2, position#matrix_to_atom_1], position#matrix_to_atom_4),
SumLeq([3, position#matrix_to_atom_2], position#matrix_to_atom_5),
SumGeq([3, position#matrix_to_atom_2], position#matrix_to_atom_5),
(position#matrix_to_atom_6 = sum([position#matrix_to_atom_3,3,1;int(1..2)])),
allDiff(position#matrix_to_atom)

--

sum([position#matrix_to_atom_3,3,1;int(1..2)]), 
   ~~> matrix_to_list ([("Base", 2000)])
sum([position#matrix_to_atom_3,3,1;int(1..)])

--

SumLeq([2, position#matrix_to_atom_1], position#matrix_to_atom_4),
SumGeq([2, position#matrix_to_atom_1], position#matrix_to_atom_4),
SumLeq([3, position#matrix_to_atom_2], position#matrix_to_atom_5),
SumGeq([3, position#matrix_to_atom_2], position#matrix_to_atom_5),
(position#matrix_to_atom_6 = sum([position#matrix_to_atom_3,3,1;int(1..)])),
allDiff(position#matrix_to_atom), 
   ~~> constant_evaluator ([("Constant", 9001)])
SumLeq([2, position#matrix_to_atom_1], position#matrix_to_atom_4),
SumGeq([2, position#matrix_to_atom_1], position#matrix_to_atom_4),
SumLeq([3, position#matrix_to_atom_2], position#matrix_to_atom_5),
SumGeq([3, position#matrix_to_atom_2], position#matrix_to_atom_5),
(position#matrix_to_atom_6 = sum([position#matrix_to_atom_3,4;int(1..)])),
allDiff(position#matrix_to_atom)

--

(position#matrix_to_atom_6 = sum([position#matrix_to_atom_3,4;int(1..)])), 
   ~~> introduce_weighted_sumleq_sumgeq ([("Minion", 4600)])
and([SumLeq([4, position#matrix_to_atom_3], position#matrix_to_atom_6),SumGeq([4, position#matrix_to_atom_3], position#matrix_to_atom_6);int(1..)])

--

SumLeq([2, position#matrix_to_atom_1], position#matrix_to_atom_4),
SumGeq([2, position#matrix_to_atom_1], position#matrix_to_atom_4),
SumLeq([3, position#matrix_to_atom_2], position#matrix_to_atom_5),
SumGeq([3, position#matrix_to_atom_2], position#matrix_to_atom_5),
and([SumLeq([4, position#matrix_to_atom_3], position#matrix_to_atom_6),SumGeq([4, position#matrix_to_atom_3], position#matrix_to_atom_6);int(1..)]),
allDiff(position#matrix_to_atom), 
   ~~> constant_evaluator ([("Constant", 9001)])
SumLeq([2, position#matrix_to_atom_1], position#matrix_to_atom_4),
SumGeq([2, position#matrix_to_atom_1], position#matrix_to_atom_4),
SumLeq([3, position#matrix_to_atom_2], position#matrix_to_atom_5),
SumGeq([3, position#matrix_to_atom_2], position#matrix_to_atom_5),
SumLeq([4, position#matrix_to_atom_3], position#matrix_to_atom_6),
SumGeq([4, position#matrix_to_atom_3], position#matrix_to_atom_6),
allDiff(position#matrix_to_atom)

--

allDiff(position#matrix_to_atom), 
   ~~> matrix_ref_to_atom ([("Base", 2000)])
allDiff([position#matrix_to_atom_1,position#matrix_to_atom_2,position#matrix_to_atom_3,position#matrix_to_atom_4,position#matrix_to_atom_5,position#matrix_to_atom_6;int(1..)])

--

allDiff([position#matrix_to_atom_1,position#matrix_to_atom_2,position#matrix_to_atom_3,position#matrix_to_atom_4,position#matrix_to_atom_5,position#matrix_to_atom_6;int(1..)]), 
   ~~> introduce_flat_alldiff ([("Minion", 4200)])
__flat_alldiff([position#matrix_to_atom_1, position#matrix_to_atom_2, position#matrix_to_atom_3, position#matrix_to_atom_4, position#matrix_to_atom_5, position#matrix_to_atom_6])

--

Final model:

letting k be 3
find position: matrix indexed by [positionDomain] of positionDomain
letting positionDomain be domain int(1..two_k)
letting two_k be 6
find position#matrix_to_atom_1: int(1..6)
find position#matrix_to_atom_2: int(1..6)
find position#matrix_to_atom_3: int(1..6)
find position#matrix_to_atom_4: int(1..6)
find position#matrix_to_atom_5: int(1..6)
find position#matrix_to_atom_6: int(1..6)

such that

SumLeq([2, position#matrix_to_atom_1], position#matrix_to_atom_4),
SumGeq([2, position#matrix_to_atom_1], position#matrix_to_atom_4),
SumLeq([3, position#matrix_to_atom_2], position#matrix_to_atom_5),
SumGeq([3, position#matrix_to_atom_2], position#matrix_to_atom_5),
SumLeq([4, position#matrix_to_atom_3], position#matrix_to_atom_6),
SumGeq([4, position#matrix_to_atom_3], position#matrix_to_atom_6),
__flat_alldiff([position#matrix_to_atom_1, position#matrix_to_atom_2, position#matrix_to_atom_3, position#matrix_to_atom_4, position#matrix_to_atom_5, position#matrix_to_atom_6])

